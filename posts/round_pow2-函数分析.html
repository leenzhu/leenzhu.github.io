<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="leen"><meta name=description content="网上搜了一圈没有搜到对这个函数的说明。这个函数的名称给我造成一些误解，让我认为这是四舍五入的概念，对于浮点数取整一般有3种情况：
"><meta name=keywords content="vpp"><link rel=canonical href=https://leenzhu.com/posts/round_pow2-%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90.html><title>round_pow2 函数分析 &#183; Leen Zhu</title><link rel="shortcut icon" href=/image/logo.png><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/chroma.css><link rel=stylesheet href=/scss/sun.min.173be92a65a018529d78026ec3240959d2a3dd35b070c391cad265c861d20173.css integrity="sha256-FzvpKmWgGFKdeAJuwyQJWdKj3TWwcMORytJlyGHSAXM=" crossorigin=anonymous></head><body><div class=main><header class="header clearfix"><a href=/ class=site-logo><img src=/image/logo.png></img></a><div class=site-info><h1 class=site-name><a href=/>Leen Zhu</a></h1><p class=site-description>while(life--) money++;</p></div><nav class=site-nav><a href=/>首页</a>
<a href=/posts.html>归档</a>
<a href=/categories.html>分类</a>
<a href=/tags.html>标签</a>
<a href=/about.html>关于</a></nav></header><div class=content><div class=post-page><div class=print-url>https://leenzhu.com/posts/round_pow2-%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90.html</div><h1><a href=/posts/round_pow2-%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90.html>round_pow2 函数分析</a></h1><div class=post-meta><span class=date>2023-07-25</span>
<span class="field tags"><a class=tag href=https://leenzhu.com/tags/vpp.html>#vpp</a></span></div><hr><div class=post-content><p>网上搜了一圈没有搜到对这个函数的说明。这个函数的名称给我造成一些误解，让我认为这是<strong>四舍五入</strong>的概念，对于浮点数取整一般有3种情况：</p><blockquote><ul><li><strong>round:</strong> 四舍五入</li><li><strong>floor:</strong> 向下取整</li><li><strong>ceil:</strong> 向上取整</li></ul></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>always_inline uword <span style=color:#06287e>round_pow2</span> (uword x, uword pow2)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> (x <span style=color:#666>+</span> pow2 <span style=color:#666>-</span> <span style=color:#40a070>1</span>) <span style=color:#666>&amp;~</span> (pow2 <span style=color:#666>-</span> <span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个函数虽然不是作用于对浮点数，但它的行为更接近<strong>ceil</strong>,即向上取整。</p><p>简单的说这个函数作用就是将<code>x</code>取整成<code>pow2</code>的整倍数。同时要求取整后的结果必须大于等于x的值。</p><p>这个函有一点需要注意：参数<code>pow2</code>必须是大于等2，并且是2的幂。</p><p>下面来看下运算过程：</p><ol><li><code>pow2 - 1</code>：因为<code>pow2</code>是2的幂，<code>pow2</code>就可以表示为<code>1 &lt;&lt; n</code>（其中<code>n >= 1</code>）如果<code>pow2=8</code>，那么<code>n=3</code>，二进制值就是<code>0000 1000</code>。<code>pow2 - 1</code>的值就是<code>0000 0111</code>。</li><li><code>~(pow2 - 1)</code>: 取反后的结果就是：<code>1111 1000</code>，这样就得到了计算<code>pow2</code>整倍数二进制掩码，任何数与这个掩码相于都可以被<code>pow2</code>整除。</li><li><code>x + pow2 - 1</code>: 任何一个数与上面的掩码进行相于都会得到一个小于等<code>pow2</code>的数。所需要<code>x</code>加上一个<code>pow2</code>最大的模数(<code>pow2-1</code>)，确保<code>x</code>向上靠近pow2的整倍数。</li><li><code>(x + pow2 - 1) &~ (pow2 - 1)</code>： 对结果进行<code>pow2</code>掩码运算，最终得到一个pow2的整倍数，并且可以保证结果大于等于<code>x</code>。</li></ol></div><div class=page-nav><a href=/posts/golang-binary.html class="nav-btn page-next">Golang Binary包使用</a>
<a href=/posts/git%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF%E4%B8%8E%E8%BF%9C%E7%AB%AF%E9%87%8D%E5%90%8D.html class="nav-btn page-prev">git本地分支与远端重名</a></div><div class=comment style=clear:both;margin-top:5em></div></div></div></div><div class=footer><div class=copyright>@2019 <a href=https://leenzhu.com>LeenZhu</a></div><div class=powered_by>Power by <a href=http://www.gohugo.io/>Hugo</a>,
using <a href=https://github.com/leenzhu/hugo-theme-sun>Sun</a> Theme</div></div></body></html>